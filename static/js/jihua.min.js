!function(d){var t="/api",k={},n={activity:'<div class="op"><div class="arrow"></div><div title="编辑" class="edit"></div><div title="删除" class="del"></div><div title="放入今日计划" class="a2t"></div><div title="添加于 <%= created %>" class="timestamp" data-timestamp="<%= timestamp %>"></div></div><div class="activity"><%= content %></div>',todo:'<div class="op"><div class="arrow"></div><div title="编辑" class="edit"></div><div title="删除" class="del"></div><div title="放回活动清单" class="t2a"></div><div title="添加于 <%= created %>" class="timestamp" data-timestamp="<%= timestamp %>"></div></div><div class="checkbox">&#x2713;</div><div class="todo"><%= content %></div>',today:'<div class="clearfix"><input class="span-new" id="new-todo" placeholder="输入计划，回车保存"><button id="submit-todo" data-loading-text="添加中..." class="btn primary">添加</button></div><ul class="todos"></ul>',activities:'<div class="clearfix"><input class="span-new" id="new-activity" placeholder="输入活动，回车保存"><button id="submit-activity" data-loading-text="添加中..." class="btn primary">添加</button></div><ul class="activities"></ul>',tab_item:'<li><a class="plus" href="#!/<%- name %>">搜索结果</a></li>',common:'<div class="clearfix"><h4><%- title %></h4></div><ul class="todos"></ul>',loading:'<div class="loading more"></div>',modal:'<div class="modal-header"><a href="#" class="close">&times;</a><h3><%= title %></h3></div><div class="modal-body"><%= body %></div><div class="modal-footer"><a href="#" class="btn ok <%= btn1_class %>"><%= btn1 %></a><a href="#" class="btn cancel <%= btn2_class %>"><%= btn2 %></a></div>'},x=function(B){var D=0;for(var E=0,C=B.length;E<C;E++){D+=B.charCodeAt(E)}return"cl"+(D%30)},z=function(B){B&&(B="!/"+B);Backbone.history.navigate(B,true)},f=100;Date.fromString=function(C){var F=/(\d+)-(\d+)-(\d+) (\d+):(\d+):(\d+)/.exec(C);if(!F){return false}var G=parseInt(F[1],10),H=parseInt(F[2],10)-1,D=parseInt(F[3],10),B=parseInt(F[4],10),I=parseInt(F[5],10),E=parseInt(F[6],10);return new Date(G,H,D,B,I,E)};window.humanizeDate=function(D){var E=now(),D=Date.fromString(D),B=(E-D)/1000,C=todayts(),F=parseInt((C-D)/86400000,10);if(D>=C){if(B>3600){return""+parseInt(B/3600,10)+" 小时前"}else{if(B>1800){return"半小时前"}else{if(B>60){return""+parseInt(B/60,10)+" 分钟前"}else{return"刚刚"}}}}else{if(F>=0&&F<7){if(F==0){return"昨天 "+D.getHours()+":"+D.getMinutes()}else{if(F==1){return"前天 "+D.getHours()+":"+D.getMinutes()}else{return""+(F+1)+" 天前"}}}else{return D.getFullYear()+"/"+(D.getMonth()+1)+"/"+D.getDate()+" "+D.getHours()+":"+D.getMinutes()+":"+D.getSeconds()}}};_.extend(k,Backbone.Events);var p=Backbone.Model.extend({defaults:{catlog:"T",done:false},validate:function(B){if(B.content!==undefined&&!d.trim(B.content)){return"error"}},url:function(){var C=this.get("catlog")=="T"?"todo":"activity";var B=t+"/"+C+"/";if(!this.isNew()){return B+this.id+"/"}return B},convert:function(B){return Backbone.sync.call(this,"update",this,{url:this.url()+(this.get("catlog")=="T"?"activity":"todo")+"/",complete:B})}});var b=p.extend({defaults:{catlog:"A",done:false}});var g=Backbone.Model.extend({});var i=Backbone.Collection.extend({model:b,url:t+"/activities/",comparator:function(B){return B.get("id")}});var a=i.extend({model:p,url:t+"/todos/",comparator:function(B){var C=B.get("done")?999999999:0;return C-parseInt(B.get("id"),10)}});var u=Backbone.Collection.extend({model:g,url:t+"/tags/"});var m=Backbone.View.extend({tagName:"li",template:_.template(n.activity),events:{hover:"hover","hover .op":"hoverOp","click .edit":"edit","click .del":"del","click .a2t":"convert","click .label":"showTag"},initialize:function(){_.bindAll(this,"render","remove");this.model.bind("change",this.render);this.model.bind("destroy",this.remove);d(this.el).attr("data-aid",this.model.id);this.render()},hover:function(D){var B=d(this.el),C=D.type=="mouseenter"?"addClass":"removeClass";B[C]("hover");d(".selected").removeClass("selected")},hoverOp:function(D){var B=d(this.el).find(".op"),C=D.type=="mouseenter"?"addClass":"removeClass";B[C]("hover")},edit:function(){var C=this.model,B=new v;B.val(C.get("content"));B.setCallback(function(){B.loading();var D=C.save({content:B.val()},{complete:function(F,E){B.reset();if(E=="success"){B.hide()}else{B.error()}}});if(D===false){B.reset();B.error()}}).fire();return false},del:function(){var C=this.model,B=new s;B.setCallback(function(){B.loading();C.destroy({success:function(){B.hide()}})}).fire();return false},showTag:function(C){var B=d(C.target).text();z("tag/"+B)},convert:function(){var F=d(this.el),D=this.model,G=this,C=D.get("catlog")=="T",B=C?b:p,E=C?"newActivity":"newTodo";F.addClass("moving");D.convert(function(J,I){F.removeClass("moving");if(I=="success"){var H=new B(D.attributes);H.set({catlog:C?"A":"T",done:false});G.remove();k.trigger(E,H);if(E==="newTodo"){k.trigger("removeActivity",D)}}});return false},htmlContent:function(B){B||(B=this.model.get("content"));return B.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/(#|＃)([^\1]+?)\1/g,function(D){var C=D.substr(1,D.length-2);return'<span class="label '+x(C)+'">'+C+"</span>"})},render:function(){d(this.el).html(this.template({created:humanizeDate(this.model.get("created")),timestamp:this.model.get("created"),content:this.htmlContent()})).find(".op [title]").twipsy({animate:false});return this}});var l=m.extend({template:_.template(n.todo),events:{hover:"hover","hover .op":"hoverOp","click .edit":"edit","click .del":"del","click .t2a":"convert","click .label":"showTag","click .checkbox":"check"},check:function(){var D=d(this.el),B=this.model,C=!!!B.get("done");if(D.hasClass("moving")){return}B.set({done:C});D.addClass("moving");B.save(null,{success:function(){D.removeClass("moving")}})},render:function(){var B=d(this.el)[this.model.get("done")?"addClass":"removeClass"]("done");B.html(this.template({created:humanizeDate(this.model.get("created")),timestamp:this.model.get("created"),content:this.htmlContent()})).find(".op [title]").twipsy({animate:false});return this}});var q=Backbone.View.extend({template:n.today,events:{"click #submit-todo":"doSubmit","keydown #new-todo":"testReturn","blur #new-todo":"clearState"},initialize:function(){this.page=1;var B=d("#main .todo-data:eq(0)");B.append(this.el).append(n.loading);_.bindAll(this,"addTodo","render","nextPage");k.bind("newTodo",this.addTodo);k.bind("scrollEnd",this.nextPage);this.todos=new a;this.todos.bind("add",this.addTodo);this.todos.bind("reset",this.render);if(window.initTodos){if(window.initTodos.length<f){this.disablePaging()}this.todos.reset(window.initTodos);window.initTodos=null}else{B.addClass("loading");var C=this;this.todos.fetch({success:function(D,E){if(E.length<f){C.disablePaging()}B.removeClass("loading")},data:{range:"today"}})}},disablePaging:function(){k.unbind("scrollEnd",this.nextPage);d(this.el).next().remove()},clearState:function(){this.$("#new-todo").removeClass("inputerror")},testReturn:function(B){if(B.keyCode==13){this.doSubmit()}else{if(B.keyCode==27){this.$("#new-todo").blur()}}},doSubmit:function(){var C=this.$("#new-todo"),D=this.$("#submit-todo");C.attr("disabled","disabled");D.button("loading");var B=new p;B.save({content:C.val()},{success:function(E){C.attr("disabled",false).removeClass("inputerror").val("");D.button("reset");k.trigger("newTodo",E)},error:function(){D.button("reset");C.attr("disabled",false).addClass("inputerror")}})},addTodo:function(B){var D=this.$(".todos"),E=new l({model:B}),C=d(this.el).next();D[C.hasClass("ing")?"append":"prepend"](E.el)},remove:function(){k.unbind("newTodo",this.addTodo);this.disablePaging();return Backbone.View.prototype.remove.call(this)},nextPage:function(){var B=d(this.el).next();if(B.hasClass("ing")){return}B.addClass("ing");this.page+=1;var C=this;this.todos.fetch({success:function(D,E){if(E.length<f){C.disablePaging()}B.removeClass("ing")},data:{range:"today",page:this.page},add:true})},render:function(){var B=d(this.el).html(this.template).find(".todos");this.todos.each(function(C){var D=new l({model:C});B.append(D.el)})}});var h=Backbone.View.extend({tagName:"ul",className:"todos",initialize:function(){this.page=1;var B=d("#main .todo-data:eq(0)");B.append(this.el).append(n.loading);_.bindAll(this,"render","nextPage","addItem");k.bind("scrollEnd",this.nextPage);this.todos=new a;this.todos.bind("add",this.addItem);this.todos.bind("reset",this.render);B.addClass("loading");var D=this.options.params,C=this;this.todos.fetch({success:function(E,F){if(F.length<f){C.disablePaging()}B.removeClass("loading")},data:D})},addItem:function(B){var C=B.get("catlog")=="T"?l:m;var D=new C({model:B});this.ul.append(D.el)},remove:function(){this.disablePaging();return Backbone.View.prototype.remove.call(this)},disablePaging:function(){k.unbind("scrollEnd",this.nextPage);d(this.el).next().remove()},nextPage:function(){var B=d(this.el).next();if(B.hasClass("ing")){return}B.addClass("ing");this.page+=1;var D=this.options.params,C=this;D.page=this.page;this.todos.fetch({success:function(E,F){if(F.length<f){C.disablePaging()}B.removeClass("ing")},data:D,add:true})},render:function(){this.ul=d(this.el);this.todos.each(this.addItem)}});var r=h.extend({tagName:"div",template:_.template(n.common),render:function(){this.ul=d(this.el).append(this.template({title:this.options.title})).find(".todos");this.todos.each(this.addItem)}});var c=Backbone.View.extend({tagName:"div",className:"todo-data",template:n.activities,events:{"click #submit-activity":"doSubmit","keydown #new-activity":"testReturn","blur #new-activity":"clearState"},clearState:function(){this.$("#new-activity").removeClass("inputerror")},testReturn:function(B){if(B.keyCode==13){this.doSubmit()}else{if(B.keyCode==27){this.$("#new-activity").blur()}}},doSubmit:function(){var C=this.$("#new-activity"),D=this.$("#submit-activity");C.attr("disabled","disabled");D.button("loading");var B=new b;B.save({content:this.$("#new-activity").val()},{success:function(E){C.attr("disabled",false).removeClass("inputerror").val("");D.button("reset");k.trigger("newActivity",E)},error:function(){D.button("reset");C.attr("disabled",false).addClass("inputerror")}})},initialize:function(){_.bindAll(this,"addActivity","removeActivity","render");d("#main .row > div:eq(1)").append(this.el);k.bind("newActivity",this.addActivity);k.bind("removeActivity",this.removeActivity);this.activities=new i;this.activities.bind("add",this.addActivity);this.activities.bind("reset",this.render);if(window.initActivities){this.activities.reset(window.initActivities);window.initActivities=null}else{this.activities.fetch()}},removeActivity:function(B){this.$(".activities [data-aid="+B.id+"]").remove()},addActivity:function(C){var B=this.$(".activities"),D=new m({model:C});B.prepend(D.el)},remove:function(){k.unbind("newActivity",this.addActivity);k.unbind("removeActivity",this.removeActivity);return Backbone.View.prototype.remove.call(this)},render:function(){var B=d(this.el).html(this.template).find(".activities");this.activities.each(function(C){var D=new m({model:C});B.append(D.el)})}});var w=Backbone.View.extend({template:_.template(n.tab_item),events:{"click a":"switchPage"},switchPage:function(E){E.preventDefault();var C=d(E.target).attr("href"),D=C.substr(3);if(D==="history"){return}else{if(D==="range"){var B=new j;B.setCallback(function(){B.reset();var G=B.from().val(),F=B.to().val();if(!/^\d{4}-\d{2}-\d{2}$/.test(G)){B.from().addClass("inputerror");return false}if(!/^\d{4}-\d{2}-\d{2}$/.test(F)){B.to().addClass("inputerror");return false}if(G>=F){B.from().addClass("inputerror");B.to().addClass("inputerror");return false}B.hide();z("range/"+G+"/"+F)}).fire()}else{z(D)}}},active:function(C){this.$(".active").removeClass("active");var B=this.$('[href="#!/'+C+'"]');if(B.length>0){B.parent("li").addClass("active")}else{var D=this.$(".plus");if(D.length==0){d(this.el).append(this.template({name:C}))}else{D.attr("href","#!/"+C)}(D.length?D:this.$(".plus")).parent().addClass("active")}}});var e=Backbone.View.extend({className:"modal hide",template:_.template(n.modal),events:{"click .cancel":"hide","click .ok":"ok"},btn1_class:"primary",btn2_class:"secondary",title:"",body:"",btn1:"确定",btn2:"取消",initialize:function(){_.bindAll(this,"remove");d(document.body).append(this.el);d(this.el).bind("shown",function(){d(this).find("input:eq(0)").focus()}).bind("hide",this.remove);this.render()},hide:function(){d(this.el).modal("hide");return false},ok:function(){this.options.callback();return false},testReturn:function(B){if(B.keyCode==13){this.ok();return false}},render:function(){d(this.el).html(this.template({title:this.title,body:this.body,btn1:this.btn1,btn2:this.btn2,btn1_class:this.btn1_class,btn2_class:this.btn2_class})).modal({backdrop:true,keyboard:true,})},fire:function(){d(this.el).modal("show")},setCallback:function(B){this.options.callback=B;return this},loading:function(){this.$(".ok").button("loading")},reset:function(){this.$("input").removeClass("inputerror");this.$(".ok").button("reset")},error:function(){this.$("input").addClass("inputerror")}});var v=e.extend({title:"修改",body:'<input class="span9" />',btn1:"保存",val:function(B){if(B!==undefined){return this.$("input").val(B)}return d.trim(this.$("input").val())}});var s=e.extend({title:"删除",btn1_class:"danger",body:"确实要删除吗？"});var j=e.extend({title:"选择时间范围",body:'从 <input class="span2 from" /> 到 <input class="span2 to" />',from:function(){return this.$(".from")},to:function(){return this.$(".to")},fire:function(){d(this.el).modal("show");this.$("input").datepicker({showAnim:""}).blur()}});var y=Backbone.View.extend({tagName:"div",className:"label",initialize:function(){var B=this.model.get("name"),C=this.model.get("counts");d(this.el).text(B).attr("title",C+" 条记录").addClass(x(B)).twipsy({animate:false})}});var A=Backbone.View.extend({tagName:"div",className:"tags",events:{"click .label":"showTag"},initialize:function(){var B=d("#main .todo-data:eq(0)");B.append(this.el);_.bindAll(this,"render");this.tags=new u;this.tags.bind("reset",this.render);B.addClass("loading");this.tags.fetch({success:function(){B.removeClass("loading")}})},showTag:function(D){var C=d(D.target).twipsy("hide");var B=C.text();z("tag/"+B)},render:function(){if(!this.tags.length){return}var D=d(this.el),F=14,C=44;var B=this.tags.min(function(H){return H.get("counts")}).get("counts"),G=this.tags.max(function(H){return H.get("counts")}).get("counts"),E=G-B;if(E<=0){E=1}fontSpread=C-F;if(fontSpread<=0){fontSpread=1}fontStep=fontSpread/E;this.tags.each(function(H){var K=new y({model:H}),J=d(K.el),I=Math.ceil(F+(H.get("counts")-B)*fontStep);J.attr("style","font-size:"+I+"px;line-height:"+I+"px;");D.append(K.el)})}});var o=Backbone.Router.extend({routes:{"":"main","!/today":"today","!/yesterday":"yesterday","!/undone":"undone","!/tags":"tags","!/tag/*tag":"tag","!/search/*query":"search","!/this/:unit":"range","!/range/:from/:to":"range"},initialize:function(B,C){d("#splash").remove();this.tab=new w({el:d("#left-tab")});this.rv=new c;this.autoHeight().autoNextPage().hotkeys().misc()},main:function(){z("today")},misc:function(){d.fn.button.defaults.loadingText="请稍候...";d.ajaxSetup({cache:false});d(document).ajaxSend(function(B,C){C.setRequestHeader("X-CSRFToken",/csrftoken=([^;\s]+)/.exec(document.cookie)[1])});d("#search").keydown(function(B){if(B.keyCode==13){z("search/"+d("#search").val());return false}else{if(B.keyCode==27){d("#search").blur()}}}).parent().submit(function(){return false});d.datepicker.setDefaults({closeText:"关闭",prevText:"&#x3c;上月",nextText:"下月&#x3e;",currentText:"今天",monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],monthNamesShort:["一","二","三","四","五","六","七","八","九","十","十一","十二"],dayNames:["星期日","星期一","星期二","星期三","星期四","星期五","星期六"],dayNamesShort:["周日","周一","周二","周三","周四","周五","周六"],dayNamesMin:["日","一","二","三","四","五","六"],weekHeader:"周",dateFormat:"yy-mm-dd",firstDay:1,isRTL:false,showMonthAfterYear:true,yearSuffix:"年"});setInterval(function(){d(".timestamp").each(function(){var B=d(this),C=B.data("timestamp");if(C){B.attr("data-original-title","添加于 "+humanizeDate(C))}})},60000)},autoNextPage:function(){var B=this;d(".todo-data:eq(0)").scroll(_.debounce(function(){var C=d(this)[0];if(C.offsetHeight+C.scrollTop>=C.scrollHeight){k.trigger("scrollEnd")}},300));return this},autoHeight:function(){var B=function(){d(".todo-data").height(d(window).height()-162)};B();d(window).resize(_.debounce(B,300));return this},hotkeys:function(){var B={84:"#new-todo",89:"#new-activity",81:"#search"},C={69:".edit",68:".del",39:".t2a",37:".a2t",13:".checkbox"};d(window).keydown(function(H){var E=H.target,G=d(".modal");if(G.length>0&&H.keyCode==13){G.find(".ok").trigger("click");return false}if("INPUT,TEXTAREA".indexOf(E.tagName)!=-1||G.length>0||H.ctrlKey||H.shiftKey||H.altKey){return}switch(H.keyCode){case 84:case 89:case 81:d(B[H.keyCode]).focus();break;case 74:case 75:case 72:case 76:var I=d(".selected"),D=H.keyCode,F=I.parent().is(".activities");if(D==74||D==75){next=I[D==74?"next":"prev"]()}else{if((F&&D==76)||(!F&&D==72)){return}next=d(D==72?".todos li:eq(0)":".activities li:eq(0)")}if(I.length==0){d(".todos > li,.activities > li").eq(0).addClass("selected")}else{if(next.length!=0){next.addClass("selected");I.removeClass("selected")}}break;case 27:d(".selected").removeClass("selected");break;case 69:case 68:case 39:case 37:case 13:var I=d(".selected");if(I.hasClass("moving")){return}d(C[H.keyCode],I).trigger("click");break;default:return}return false});return this},today:function(){this.lv&&this.lv.remove();this.tab.active("today");this.lv=new q},yesterday:function(){this.lv&&this.lv.remove();this.tab.active("yesterday");this.lv=new h({params:{range:"yesterday"}})},undone:function(){this.lv&&this.lv.remove();this.tab.active("undone");this.lv=new h({params:{range:"undone"}})},tags:function(){this.lv&&this.lv.remove();this.tab.active("tags");this.lv=new A},tag:function(B){this.lv&&this.lv.remove();this.tab.active("tag/"+B);this.lv=new h({params:{tag:B}})},search:function(B){if(!d.trim(B)){return}this.lv&&this.lv.remove();this.tab.active("search/"+B);this.lv=new r({params:{query:B},title:'包含 "'+B+'" 的计划条目'})},range:function(C,B){var D=/\d{4}-\d{2}-\d{2}/;if(B===undefined&&"week,month".indexOf(C)!=-1){range=C;title=(C=="week"?"本周":"本月")+"的计划"}else{if(D.test(C)&&D.test(B)){range=C+","+B;title=(C+" ~ "+B+" 的计划").replace(/-/g,"/")}else{return}}this.lv&&this.lv.remove();this.tab.active("history");this.lv=new r({params:{range:range},title:title})}});window.Jihua=o}(jQuery);