!function(d){var u="/api",l={},o={activity:'<div class="op"><div class="edit">编辑</div><div class="del">删除</div><div title="放入今日计划" class="a2t">转计划</div><div title="添加于 <%= created %>" class="timestamp" data-timestamp="<%= timestamp %>"><%= created_short %></div></div><div class="activity"><%= content %></div>',todo:'<div class="op"><div class="edit">编辑</div><div class="del">删除</div><div title="放回活动清单" class="t2a">转活动</div><div title="添加于 <%= created %>" class="timestamp" data-timestamp="<%= timestamp %>"><%= created_short %></div></div><div class="checkbox">&#x2713;</div><div class="todo"><%= content %></div>',today:'<div class="clearfix"><input class="span-new" id="new-todo" placeholder="输入计划，回车保存"><button id="submit-todo" data-loading-text="添加中..." class="btn primary">添加</button></div><ul class="todos"></ul>',activities:'<div class="clearfix"><input class="span-new" id="new-activity" placeholder="输入活动，回车保存"><button id="submit-activity" data-loading-text="添加中..." class="btn primary">添加</button></div><ul class="activities"></ul>',tab_item:'<li><a class="plus" href="#!/<%- name %>">搜索结果</a></li>',common:'<div class="clearfix"><h4><%- title %></h4></div><ul class="todos"></ul>',loading:'<div class="loading more"></div>',modal:'<div class="modal-header"><a href="#" class="close">&times;</a><h3><%= title %></h3></div><div class="modal-body"><%= body %></div><div class="modal-footer"><a href="#" class="btn ok <%= btn1_class %>"><%= btn1 %></a><a href="#" class="btn cancel <%= btn2_class %>"><%= btn2 %></a></div>'},y=function(C){var E=0;for(var F=0,D=C.length;F<D;F++){E+=C.charCodeAt(F)}return"cl"+(E%30)},A=function(C){C&&(C="!/"+C);Backbone.history.navigate(C,true)},h=function(F,C){var D=""+F;if(D.length>=C){return D}for(var G=0,E=C-D.length;G<E;G++){D="0"+D}return D},f=100;Date.fromString=function(D){var G=/(\d+)-(\d+)-(\d+) (\d+):(\d+):(\d+)/.exec(D);if(!G){return false}var H=parseInt(G[1],10),I=parseInt(G[2],10)-1,E=parseInt(G[3],10),C=parseInt(G[4],10),J=parseInt(G[5],10),F=parseInt(G[6],10);return new Date(H,I,E,C,J,F)};window.humanizeDate=function(G){var H=now(),G=Date.fromString(G),E=(H-G)/1000,F=todayts(),I=parseInt((F-G)/86400000,10);if(G>=F){if(E>3600){var D=parseInt(E/3600,10);return[""+D+" 小时前",""+D+"时"]}else{if(E>1800){return["半小时前","半时"]}else{if(E>60){var D=parseInt(E/60,10);return[""+D+" 分钟前",""+D+"分"]}else{return["刚刚","刚刚"]}}}}else{if(I>=0&&I<7){if(I==0){return"昨天 "+h(G.getHours(),2)+":"+h(G.getMinutes(),2)}else{if(I==1){return"前天 "+h(G.getHours(),2)+":"+h(G.getMinutes(),2)}else{var D=I+1;return[""+D+" 天前",""+D+"天"]}}}else{var C=G.getFullYear()+"/"+(G.getMonth()+1)+"/"+G.getDate()+" "+h(G.getHours(),2)+":"+h(G.getMinutes(),2)+":"+h(G.getSeconds(),2);if(H.getFullYear()==G.getFullYear()){return[C,""+(G.getMonth()+1)+"月"+G.getDate()+"日"]}return[C,G.getFullYear()+"/"+(G.getMonth()+1)+"/"+G.getDate()]}}};_.extend(l,Backbone.Events);var q=Backbone.Model.extend({defaults:{catlog:"T",done:false},validate:function(C){if(C.content!==undefined&&!d.trim(C.content)){return"error"}},url:function(){var D=this.get("catlog")=="T"?"todo":"activity";var C=u+"/"+D+"/";if(!this.isNew()){return C+this.id+"/"}return C},convert:function(C){return Backbone.sync.call(this,"update",this,{url:this.url()+(this.get("catlog")=="T"?"activity":"todo")+"/",complete:C})}});var b=q.extend({defaults:{catlog:"A",done:false}});var g=Backbone.Model.extend({});var j=Backbone.Collection.extend({model:b,url:u+"/activities/",comparator:function(C){return C.get("id")}});var a=j.extend({model:q,url:u+"/todos/",comparator:function(C){var D=C.get("done")?999999999:0;return D-parseInt(C.get("id"),10)}});var v=Backbone.Collection.extend({model:g,url:u+"/tags/"});var n=Backbone.View.extend({tagName:"li",template:_.template(o.activity),events:{hover:"hover","click .edit":"edit","click .del":"del","click .a2t":"convert","click .label":"showTag"},initialize:function(){_.bindAll(this,"render","remove");this.model.bind("change",this.render);this.model.bind("destroy",this.remove);d(this.el).attr("data-aid",this.model.id);this.render()},hover:function(E){var C=d(this.el),D=E.type=="mouseenter"?"addClass":"removeClass";C[D]("hover");d(".selected").removeClass("selected")},edit:function(){var D=this.model,C=new w;C.val(D.get("content"));C.setCallback(function(){C.loading();var E=D.save({content:C.val()},{complete:function(G,F){C.reset();if(F=="success"){C.hide()}else{C.error()}}});if(E===false){C.reset();C.error()}}).fire();return false},del:function(){var D=this.model,C=new t;C.setCallback(function(){C.loading();D.destroy({success:function(){C.hide()}})}).fire();return false},showTag:function(D){var C=d(D.target).text();A("tag/"+C)},convert:function(){var G=d(this.el),E=this.model,H=this,D=E.get("catlog")=="T",C=D?b:q,F=D?"newActivity":"newTodo";G.addClass("moving");E.convert(function(K,J){G.removeClass("moving");if(J=="success"){var I=new C(E.attributes);I.set({catlog:D?"A":"T",done:false});H.remove();l.trigger(F,I);if(F==="newTodo"){l.trigger("removeActivity",E)}}});return false},htmlContent:function(C){C||(C=this.model.get("content"));return C.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/(#|＃)([^\1]+?)\1/g,function(E){var D=E.substr(1,E.length-2);return'<span class="label '+y(D)+'">'+D+"</span>"})},render:function(){var C=humanizeDate(this.model.get("created"));d(this.el).html(this.template({created:C[0],created_short:C[1],timestamp:this.model.get("created"),content:this.htmlContent()}));return this}});var m=n.extend({template:_.template(o.todo),events:{hover:"hover","click .edit":"edit","click .del":"del","click .t2a":"convert","click .label":"showTag","click .checkbox":"check"},check:function(){var E=d(this.el),C=this.model,D=!!!C.get("done");if(E.hasClass("moving")){return}C.set({done:D});E.addClass("moving");C.save(null,{success:function(){E.removeClass("moving")}})},render:function(){var C=d(this.el)[this.model.get("done")?"addClass":"removeClass"]("done"),D=humanizeDate(this.model.get("created"));C.html(this.template({created:D[0],created_short:D[1],timestamp:this.model.get("created"),content:this.htmlContent()}));return this}});var r=Backbone.View.extend({template:o.today,events:{"click #submit-todo":"doSubmit","keydown #new-todo":"testReturn","blur #new-todo":"clearState"},initialize:function(){this.page=1;var C=d("#main .todo-data:eq(0)");C.append(this.el).append(o.loading);_.bindAll(this,"addTodo","render","nextPage");l.bind("newTodo",this.addTodo);l.bind("scrollEnd",this.nextPage);this.todos=new a;this.todos.bind("add",this.addTodo);this.todos.bind("reset",this.render);if(window.initTodos){if(window.initTodos.length<f){this.disablePaging()}this.todos.reset(window.initTodos);window.initTodos=null}else{C.addClass("loading");var D=this;this.todos.fetch({success:function(E,F){if(F.length<f){D.disablePaging()}C.removeClass("loading")},data:{range:"today"}})}},disablePaging:function(){l.unbind("scrollEnd",this.nextPage);d(this.el).next().remove()},clearState:function(){this.$("#new-todo").removeClass("inputerror")},testReturn:function(C){if(C.keyCode==13){this.doSubmit()}else{if(C.keyCode==27){this.$("#new-todo").blur()}}},doSubmit:function(){var D=this.$("#new-todo"),E=this.$("#submit-todo");D.attr("disabled","disabled");E.button("loading");var C=new q;C.save({content:D.val()},{success:function(F){D.attr("disabled",false).removeClass("inputerror").val("");E.button("reset");l.trigger("newTodo",F)},error:function(){E.button("reset");D.attr("disabled",false).addClass("inputerror")}})},addTodo:function(C){var E=this.$(".todos"),F=new m({model:C}),D=d(this.el).next();E[D.hasClass("ing")?"append":"prepend"](F.el)},remove:function(){l.unbind("newTodo",this.addTodo);this.disablePaging();return Backbone.View.prototype.remove.call(this)},nextPage:function(){var C=d(this.el).next();if(C.hasClass("ing")){return}C.addClass("ing");this.page+=1;var D=this;this.todos.fetch({success:function(E,F){if(F.length<f){D.disablePaging()}C.removeClass("ing")},data:{range:"today",page:this.page},add:true})},render:function(){var C=d(this.el).html(this.template).find(".todos");this.todos.each(function(D){var E=new m({model:D});C.append(E.el)})}});var i=Backbone.View.extend({tagName:"ul",className:"todos",initialize:function(){this.page=1;var C=d("#main .todo-data:eq(0)");C.append(this.el).append(o.loading);_.bindAll(this,"render","nextPage","addItem");l.bind("scrollEnd",this.nextPage);this.todos=new a;this.todos.bind("add",this.addItem);this.todos.bind("reset",this.render);C.addClass("loading");var E=this.options.params,D=this;this.todos.fetch({success:function(F,G){if(G.length<f){D.disablePaging()}C.removeClass("loading")},data:E})},addItem:function(C){var D=C.get("catlog")=="T"?m:n;var E=new D({model:C});this.ul.append(E.el)},remove:function(){this.disablePaging();return Backbone.View.prototype.remove.call(this)},disablePaging:function(){l.unbind("scrollEnd",this.nextPage);d(this.el).next().remove()},nextPage:function(){var C=d(this.el).next();if(C.hasClass("ing")){return}C.addClass("ing");this.page+=1;var E=this.options.params,D=this;E.page=this.page;this.todos.fetch({success:function(F,G){if(G.length<f){D.disablePaging()}C.removeClass("ing")},data:E,add:true})},render:function(){this.ul=d(this.el);this.todos.each(this.addItem)}});var s=i.extend({tagName:"div",template:_.template(o.common),render:function(){this.ul=d(this.el).append(this.template({title:this.options.title})).find(".todos");this.todos.each(this.addItem)}});var c=Backbone.View.extend({tagName:"div",className:"todo-data",template:o.activities,events:{"click #submit-activity":"doSubmit","keydown #new-activity":"testReturn","blur #new-activity":"clearState"},clearState:function(){this.$("#new-activity").removeClass("inputerror")},testReturn:function(C){if(C.keyCode==13){this.doSubmit()}else{if(C.keyCode==27){this.$("#new-activity").blur()}}},doSubmit:function(){var D=this.$("#new-activity"),E=this.$("#submit-activity");D.attr("disabled","disabled");E.button("loading");var C=new b;C.save({content:this.$("#new-activity").val()},{success:function(F){D.attr("disabled",false).removeClass("inputerror").val("");E.button("reset");l.trigger("newActivity",F)},error:function(){E.button("reset");D.attr("disabled",false).addClass("inputerror")}})},initialize:function(){_.bindAll(this,"addActivity","removeActivity","render");d("#main .row > div:eq(1)").append(this.el);l.bind("newActivity",this.addActivity);l.bind("removeActivity",this.removeActivity);this.activities=new j;this.activities.bind("add",this.addActivity);this.activities.bind("reset",this.render);if(window.initActivities){this.activities.reset(window.initActivities);window.initActivities=null}else{this.activities.fetch()}},removeActivity:function(C){this.$(".activities [data-aid="+C.id+"]").remove()},addActivity:function(D){var C=this.$(".activities"),E=new n({model:D});C.prepend(E.el)},remove:function(){l.unbind("newActivity",this.addActivity);l.unbind("removeActivity",this.removeActivity);return Backbone.View.prototype.remove.call(this)},render:function(){var C=d(this.el).html(this.template).find(".activities");this.activities.each(function(D){var E=new n({model:D});C.append(E.el)})}});var x=Backbone.View.extend({template:_.template(o.tab_item),events:{"click a":"switchPage"},switchPage:function(F){F.preventDefault();var D=d(F.target).attr("href"),E=D.substr(3);if(E==="history"){return}else{if(E==="range"){var C=new k;C.setCallback(function(){C.reset();var H=C.from().val(),G=C.to().val();if(!/^\d{4}-\d{2}-\d{2}$/.test(H)){C.from().addClass("inputerror");return false}if(!/^\d{4}-\d{2}-\d{2}$/.test(G)){C.to().addClass("inputerror");return false}if(H>=G){C.from().addClass("inputerror");C.to().addClass("inputerror");return false}C.hide();A("range/"+H+"/"+G)}).fire()}else{A(E)}}},active:function(D){this.$(".active").removeClass("active");var C=this.$('[href="#!/'+D+'"]');if(C.length>0){C.parent("li").addClass("active")}else{var E=this.$(".plus");if(E.length==0){d(this.el).append(this.template({name:D}))}else{E.attr("href","#!/"+D)}(E.length?E:this.$(".plus")).parent().addClass("active")}}});var e=Backbone.View.extend({className:"modal hide",template:_.template(o.modal),events:{"click .cancel":"hide","click .ok":"ok"},btn1_class:"primary",btn2_class:"secondary",title:"",body:"",btn1:"确定",btn2:"取消",initialize:function(){_.bindAll(this,"remove");d(document.body).append(this.el);d(this.el).bind("shown",function(){d(this).find("input:eq(0)").focus()}).bind("hide",this.remove);this.render()},hide:function(){d(this.el).modal("hide");return false},ok:function(){this.options.callback();return false},testReturn:function(C){if(C.keyCode==13){this.ok();return false}},render:function(){d(this.el).html(this.template({title:this.title,body:this.body,btn1:this.btn1,btn2:this.btn2,btn1_class:this.btn1_class,btn2_class:this.btn2_class})).modal({backdrop:true,keyboard:true,})},fire:function(){d(this.el).modal("show")},setCallback:function(C){this.options.callback=C;return this},loading:function(){this.$(".ok").button("loading")},reset:function(){this.$("input").removeClass("inputerror");this.$(".ok").button("reset")},error:function(){this.$("input").addClass("inputerror")}});var w=e.extend({title:"修改",body:'<input class="span9" />',btn1:"保存",val:function(C){if(C!==undefined){return this.$("input").val(C)}return d.trim(this.$("input").val())}});var t=e.extend({title:"删除",btn1_class:"danger",body:"确实要删除吗？"});var k=e.extend({title:"选择时间范围",body:'从 <input class="span2 from" /> 到 <input class="span2 to" />',from:function(){return this.$(".from")},to:function(){return this.$(".to")},fire:function(){d(this.el).modal("show");this.$("input").datepicker({showAnim:""}).blur()}});var z=Backbone.View.extend({tagName:"div",className:"label",initialize:function(){var C=this.model.get("name"),D=this.model.get("counts");d(this.el).text(C).attr("title",D+" 条记录").addClass(y(C)).twipsy({animate:false})}});var B=Backbone.View.extend({tagName:"div",className:"tags",events:{"click .label":"showTag"},initialize:function(){var C=d("#main .todo-data:eq(0)");C.append(this.el);_.bindAll(this,"render");this.tags=new v;this.tags.bind("reset",this.render);C.addClass("loading");this.tags.fetch({success:function(){C.removeClass("loading")}})},showTag:function(E){var D=d(E.target).twipsy("hide");var C=D.text();A("tag/"+C)},render:function(){if(!this.tags.length){return}var E=d(this.el),G=14,D=44;var C=this.tags.min(function(I){return I.get("counts")}).get("counts"),H=this.tags.max(function(I){return I.get("counts")}).get("counts"),F=H-C;if(F<=0){F=1}fontSpread=D-G;if(fontSpread<=0){fontSpread=1}fontStep=fontSpread/F;this.tags.each(function(I){var L=new z({model:I}),K=d(L.el),J=Math.ceil(G+(I.get("counts")-C)*fontStep);K.attr("style","font-size:"+J+"px;line-height:"+J+"px;");E.append(L.el)})}});var p=Backbone.Router.extend({routes:{"":"main","!/today":"today","!/yesterday":"yesterday","!/undone":"undone","!/tags":"tags","!/tag/*tag":"tag","!/search/*query":"search","!/this/:unit":"range","!/last/week":"lastweek","!/range/:from/:to":"range"},initialize:function(C,D){d("#splash").remove();this.tab=new x({el:d("#left-tab")});this.rv=new c;this.autoHeight().autoNextPage().hotkeys().misc()},main:function(){A("today")},misc:function(){d.fn.button.defaults.loadingText="请稍候...";d.ajaxSetup({cache:false});d(document).ajaxSend(function(C,D){D.setRequestHeader("X-CSRFToken",/csrftoken=([^;\s]+)/.exec(document.cookie)[1])});d("#search").keydown(function(C){if(C.keyCode==13){A("search/"+d("#search").val());return false}else{if(C.keyCode==27){d("#search").blur()}}}).parent().submit(function(){return false});d.datepicker.setDefaults({closeText:"关闭",prevText:"&#x3c;上月",nextText:"下月&#x3e;",currentText:"今天",monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],monthNamesShort:["一","二","三","四","五","六","七","八","九","十","十一","十二"],dayNames:["星期日","星期一","星期二","星期三","星期四","星期五","星期六"],dayNamesShort:["周日","周一","周二","周三","周四","周五","周六"],dayNamesMin:["日","一","二","三","四","五","六"],weekHeader:"周",dateFormat:"yy-mm-dd",firstDay:1,isRTL:false,showMonthAfterYear:true,yearSuffix:"年"});setInterval(function(){d(".timestamp").each(function(){var C=d(this),D=C.data("timestamp");if(D){var E=humanizeDate(D);C.attr("data-original-title","添加于 "+E[0]).text(E[1])}})},60000)},autoNextPage:function(){var C=this;d(".todo-data:eq(0)").scroll(_.debounce(function(){var D=d(this)[0];if(D.offsetHeight+D.scrollTop>=D.scrollHeight){l.trigger("scrollEnd")}},300));return this},autoHeight:function(){var C=function(){d(".todo-data").height(d(window).height()-162)};C();d(window).resize(_.debounce(C,300));return this},hotkeys:function(){var C={84:"#new-todo",89:"#new-activity",81:"#search"},D={69:".edit",68:".del",39:".t2a",37:".a2t",13:".checkbox"};d(window).keydown(function(I){var F=I.target,H=d(".modal");if(H.length>0&&I.keyCode==13){H.find(".ok").trigger("click");return false}if("INPUT,TEXTAREA".indexOf(F.tagName)!=-1||H.length>0||I.ctrlKey||I.shiftKey||I.altKey){return}switch(I.keyCode){case 84:case 89:case 81:d(C[I.keyCode]).focus();break;case 74:case 75:case 72:case 76:var J=d(".selected"),E=I.keyCode,G=J.parent().is(".activities");if(E==74||E==75){next=J[E==74?"next":"prev"]()}else{if((G&&E==76)||(!G&&E==72)){return}next=d(E==72?".todos li:eq(0)":".activities li:eq(0)")}if(J.length==0){d(".todos > li,.activities > li").eq(0).addClass("selected")}else{if(next.length!=0){next.addClass("selected");J.removeClass("selected")}}break;case 27:d(".selected").removeClass("selected");break;case 69:case 68:case 39:case 37:case 13:var J=d(".selected");if(J.hasClass("moving")){return}d(D[I.keyCode],J).trigger("click");break;default:return}return false});return this},today:function(){this.lv&&this.lv.remove();this.tab.active("today");this.lv=new r},yesterday:function(){this.lv&&this.lv.remove();this.tab.active("yesterday");this.lv=new i({params:{range:"yesterday"}})},undone:function(){this.lv&&this.lv.remove();this.tab.active("undone");this.lv=new i({params:{range:"undone"}})},tags:function(){this.lv&&this.lv.remove();this.tab.active("tags");this.lv=new B},tag:function(C){this.lv&&this.lv.remove();this.tab.active("tag/"+C);this.lv=new i({params:{tag:C}})},search:function(C){if(!d.trim(C)){return}this.lv&&this.lv.remove();this.tab.active("search/"+C);this.lv=new s({params:{query:C},title:'包含 "'+C+'" 的计划条目'})},lastweek:function(){this.range("lastweek")},range:function(D,C){var E=/\d{4}-\d{2}-\d{2}/;if(C===undefined&&"week,month,lastweek".indexOf(D)!=-1){range=D;title=(D=="week"?"本周":(D=="month"?"本月":"上周"))+"的计划"}else{if(E.test(D)&&E.test(C)){range=D+","+C;title=(D+" ~ "+C+" 的计划").replace(/-/g,"/")}else{return}}this.lv&&this.lv.remove();this.tab.active("history");this.lv=new s({params:{range:range},title:title})}});window.Jihua=p}(jQuery);